version: '3.8'

services:
  iac-scanner:
    build: .
    image: iac-scanner
    container_name: iac-scanner
    networks:
      - gitlab-net
    ports:
      - "8080:8080"  # 호스트:컨테이너
    environment:
      # Docker 네트워크 내에서 GitLab 컨테이너 이름으로 접근
      - GITLAB_URL=http://local-gitlab:80
      - GITLAB_TOKENS=${GITLAB_TOKENS}
      - WEBHOOK_SECRET=${WEBHOOK_SECRET}
      - SERVER_PORT=8080
      - STORAGE_PATH=/app/storage
      - TRIVY_BIN_PATH=/app/bin/trivy
      - PARSER_BIN_PATH=/app/bin/trivy-parser
      - CUSTOM_POLICIES_PATH=/app/custom-policies
      - SCAN_RESULTS_PATH=/app/scan-results
    volumes:
      # 다운로드된 파일을 호스트에 마운트
      - ./storage:/app/storage
      # 스캔 결과를 호스트에 마운트
      - ./scan-results:/app/scan-results
    restart: unless-stopped
    # GitLab과 같은 네트워크에서 iac-scanner 이름으로 접근 가능

networks:
  gitlab-net:
    external: true  # local-gitlab이 생성한 네트워크 사용
    name: gitlab-net